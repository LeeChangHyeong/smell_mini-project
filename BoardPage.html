<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smell : ë³´ë“œí˜ì´ì§€</title>
    <!-- Bootstrap CSS ìŠ¤íƒ€ì¼ì‹œíŠ¸ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ link íƒœê·¸. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /*í°íŠ¸*/
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');

        * {
            font-family: "Gowun Dodum", sans-serif;
        }

        /*ìƒë‹¨ì˜ ë¡œê³ */
        .title_logo {
            height: 150px;
            /*ë¡œê³  ë†’ì´ 150*/
            color: white;
            /*í…ìŠ¤íŠ¸ ìƒ‰ìƒ : white*/
            display: flex;
            /* flexbox ë ˆì´ì•„ì›ƒì„ ì‚¬ìš©í•˜ì—¬ ìš”ì†Œë¥¼ ê°€ìš´ë° ì •ë ¬ */
            flex-direction: column;
            /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ë°°ì¹˜ */
            align-items: center;
            /* ìˆ˜í‰ê³¼ ìˆ˜ì§ìœ¼ë¡œ ê°€ìš´ë° ì •ë ¬ */
            justify-content: center;
            /* ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì • */
            background-image: url('https://github.com/LeeNaYoung240/smell_mini-project/assets/107848521/22f3545f-bd3c-4ae7-920c-8a9dcbb86edb');
            background-position: center;
            background-size: cover;
            /* ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì»¤ë²„í•˜ëŠ” í¬ê¸°ë¡œ ì„¤ì • */
        }

        .title {
            display: flex;
            /* flexbox ë ˆì´ì•„ì›ƒì„ ì‚¬ìš©í•˜ì—¬ ìš”ì†Œë¥¼ ê°€ìš´ë° ì •ë ¬ */
            flex-direction: column;
            /* ìš”ì†Œë¥¼ ìˆ˜í‰ ë°©í–¥ìœ¼ë¡œ ë°°ì¹˜ */
            align-items: center;
            /* ì•„ì´í…œì„ ìˆ˜ì§ê³¼ ìˆ˜í‰ìœ¼ë¡œ ê°€ìš´ë° ì •ë ¬ */
            justify-content: center;
            padding: 50px;
        }

        .writer {
            text-align: right;
            padding: 0px 40px 0px 0px;
        }

        .date {
            text-align: right;
            padding: 0px 40px 0px 0px;
        }

        .time {
            text-align: right;
            padding: 0px 40px 10px 0px;
        }

        .content {
            text-align: left;
            padding: 10px 50px 30px 50px;
        }

        .card-footer {
            padding: 20px;
        }
    </style>
    <script type="module">
        /*temperatureì— ë‚ ì”¨ ë°ì´í„° ì…ë ¥*/
        $(document).ready(function () {
            let url = "http://spartacodingclub.shop/sparta_api/weather/seoul";  // ì„œìš¸ ë‚ ì”¨ API ìš”ì²­ì„ ìœ„í•œ URL 
            // í•´ë‹¹ URLë¡œ GET ìš”ì²­ì„ ë³´ë‚´ê³ , ë°›ì€ ì‘ë‹µì„ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            fetch(url).then(res => res.json()).then(data => {
                let temp = data['temp']; // ì‘ë‹µì—ì„œ ì˜¨ë„ ì •ë³´ ì¶”ì¶œ
                $('#temperature').text(temp);  // ì˜¨ë„ ì •ë³´ë¥¼ í•´ë‹¹ ìš”ì†Œì— í…ìŠ¤íŠ¸ë¡œ ì¶”ê°€
            });
        });
        
        // Firebase SDK ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        // Firebase êµ¬ì„± ì •ë³´ ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyB-eyQJ5vsYV1VPXbhXvUu0Bm5Do0AfGmY",
            authDomain: "smell-19e9a.firebaseapp.com",
            projectId: "smell-19e9a",
            storageBucket: "smell-19e9a.appspot.com",
            messagingSenderId: "321477657279",
            appId: "1:321477657279:web:48bec02f302e4b7bfb7c0a",
            measurementId: "G-78FKFTNFZ4"
        };
        // Firebase ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // URLì—ì„œ ì¿¼ë¦¬ ë¬¸ìì—´ ê°€ì ¸ì˜¤ê¸°
        const queryString = window.location.search;
        // URL ì¿¼ë¦¬ ë¬¸ìì—´ íŒŒì‹±í•˜ì—¬ ê°ì²´ë¡œ ë³€í™˜
        const urlParams = new URLSearchParams(queryString);
        // index ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì„ ê°€ì ¸ì˜¤ê¸°
        const index = urlParams.get('index');
        // indexë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì‚¬ìš©
        const boardName = urlParams.get('boardName');
        console.log(boardName);
        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        $("#logoutbtn").click(function () {
            // Firebaseì—ì„œ ë¡œê·¸ì•„ì›ƒ
            auth.signOut().then(() => {
                // ë¡œê·¸ì•„ì›ƒ ì„±ê³µí•œ ê²½ìš°, í˜ì´ì§€ë¥¼ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "LoginPage.html"; // LoginPage.htmlì€ ì‹¤ì œ ë¡œê·¸ì¸ í˜ì´ì§€ íŒŒì¼ëª…ì— ë§ê²Œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
            }).catch((error) => {
                // ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨í•œ ê²½ìš°, ì½˜ì†”ì— ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
                console.error("ë¡œê·¸ì•„ì›ƒ ì—ëŸ¬:", error);
            });
        });
        const postDocRef = doc(db, "posts", boardName);
        getDoc(postDocRef).then((docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                const useData = data.contents[index]; // ìˆ«ì ë„˜ê²¨ ì™€ì„œ ë°›ì•„ì™€ì•¼í•¨
                const title = useData.title;
                const date = useData.date;
                const time = useData.time;
                const content = useData.content;
                const comments = useData.comments;
                const writer = useData.writer;
                console.log(time);
                console.log(comments);
                $(".title").append(`<h1>${title}</h1>`);
                $(".content").append(`<h2>${content}</h2>`);
                $(".date").append(`<h5>ğŸ“… ${date}</h5>`);
                $(".time").append(`<h5>ğŸ•– ${time}</h5>`);
                $(".writer").append(`<h5>ì‘ì„±ì: ${writer}</h5>`);
                const commentsDiv = document.querySelector('.comments');
                comments.forEach(comment => {
                    const newCommentDiv = document.createElement('div');
                    console.log(comment.name);
                    newCommentDiv.innerHTML = `
                <br>
                <p style="font-weight: bolder;">${comment.name}</p>
                <div>${comment.comment}</div>
                <br>
                <p style="font-size: 10px; font-weight: lighter;">${comment.date}</p>
                <hr>
            `;
                    commentsDiv.appendChild(newCommentDiv);
                });


            } else {
                $(".title").append(`<h1>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h1>`);
                $(".content").append(`<h2>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>`);
                $(".date").append(`<h5>ë‚ ì§œì™€ ì‹œê°„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h5>`);
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });
        async function addComment(event) {
    event.preventDefault(); // í¼ ì œì¶œì˜ ê¸°ë³¸ ë™ì‘ ë°©ì§€
    const comment = document.getElementById('commentInput').value.trim(); // ì…ë ¥ëœ ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    if (comment !== '') { // ëŒ“ê¸€ì´ ë¹„ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        const commentsDiv = document.querySelector('.comments'); // ëŒ“ê¸€ì„ í‘œì‹œí•  div ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const newCommentDiv = document.createElement('div'); // ìƒˆë¡œìš´ ëŒ“ê¸€ì„ ë‹´ì„ div ìš”ì†Œ ìƒì„±
        // í˜„ì¬ ì‹œê°„ì„ êµ¬í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì™€ì„œ í‘œì‹œ
        const currentTime = getCurrentDateTime();
        let userName = ""; // ë³€ìˆ˜ ì„ ì–¸

        // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const user = auth.currentUser;
        if (user) {
            const userDocRef = doc(db, "users", user.uid); // ì‚¬ìš©ìì˜ UIDë¥¼ ì´ìš©í•˜ì—¬ ë¬¸ì„œ ì°¸ì¡° 
            try {
                const docSnapshot = await getDoc(userDocRef);
                if (docSnapshot.exists()) {
                    const userData = docSnapshot.data();
                    userName = userData.name; // ì‚¬ìš©ì ì´ë¦„ í• ë‹¹
                }
            } catch (error) {
                console.error("ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
            }
        }

        newCommentDiv.innerHTML = `
            <br>
            <p style="font-weight: bolder;">${userName}</p>
            <div>${comment}</div>
            <br>
            <p style="font-size: 10px; font-weight: lighter;">${currentTime}</p>
            <hr>
        `;
        commentsDiv.appendChild(newCommentDiv); // ìƒˆë¡œìš´ ëŒ“ê¸€ì„ í‘œì‹œí•  divì— ì¶”ê°€

        document.getElementById('commentForm').reset(); // í¼ ë¦¬ì…‹

        // ëŒ“ê¸€ ë°ì´í„° Firestoreì— ì €ì¥
        const postDocRef = doc(db, "posts", boardName); // ê²Œì‹œë¬¼ì˜ ì „ì²´ ë¬¸ì„œ ì°¸ì¡°
        try {
            const docSnapshot = await getDoc(postDocRef);
            if (docSnapshot.exists()) {
                const postData = docSnapshot.data();
                const currentContents = postData.contents[index];
                if (currentContents) {
                    // ìƒˆë¡œìš´ ëŒ“ê¸€ ê°ì²´ ìƒì„±
                    const newComment = {
                        name: userName,
                        date: currentTime,
                        comment: comment
                    };
                    // í˜„ì¬ ëŒ“ê¸€ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
                    let currentComments = currentContents.comments || [];
                    currentComments.push(newComment);
                    currentContents.comments = currentComments;
                    // ë¬¸ì„œ ì—…ë°ì´íŠ¸
                    await setDoc(postDocRef, { contents: postData.contents });
                    console.log("ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    alert("ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    console.log("í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ê²Œì‹œë¬¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            } else {
                console.log("í•´ë‹¹ ê²Œì‹œë¬¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("ëŒ“ê¸€ ì¶”ê°€ ì—ëŸ¬:", error);
        }
    }
}

 
        // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ë¬¸ìì—´ë¡œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1ì„ ë”í•˜ê³  2ìë¦¬ë¡œ ë§Œë“­ë‹ˆë‹¤.
            const day = String(now.getDate()).padStart(2, '0'); // ì¼
            const hours = String(now.getHours()).padStart(2, '0'); // ì‹œ
            const minutes = String(now.getMinutes()).padStart(2, '0'); // ë¶„
            const seconds = String(now.getSeconds()).padStart(2, '0'); // ì´ˆ
            return `${year}.${month}.${day}. ${hours}:${minutes}:${seconds}`;
        }
        // ëŒ“ê¸€ í¼ì— ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('commentForm').addEventListener('submit', addComment);
    </script>
</head>

<body>
    <header class="p-3 text-bg-dark">
        <!-- ì»¨í…Œì´ë„ˆë¥¼ í¬í•¨í•˜ëŠ” div ìš”ì†Œë¡œ í—¤ë”ë¥¼ ê°ì‹¸ì¤Œ -->
        <div class="container">
            <!-- flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì†Œë“¤ì„ ê°€ë¡œë¡œ ì •ë ¬ -->
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <!-- ë¡œê³  ë§í¬, í™ˆìœ¼ë¡œ ì´ë™í•˜ëŠ” ë§í¬ë¡œ ì„¤ì •-->
                <a href="/" class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none">
                    <svg class="bi me-2" width="40" height="32" role="img" aria-label="Bootstrap">
                        <use xlink:href="#bootstrap"></use>
                    </svg>
                </a>
                <!-- ë©”ë‰´ ëª©ë¡ -->
                <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
                    <li><a href="MyPage.html" class="nav-link px-2 text-secondary">Mypage</a></li>
                    <li><a href="StudyPage.html" class="nav-link px-2 text-secondary">Study</a></li>
                    <li><a href="#" class="nav-link px-2 text-secondary">ì„œìš¸ì˜ ê¸°ì˜¨ : <span
                                id="temperature">20.00</span>ë„
                            <span id="temperature"></span></a></li>
                </ul>
                <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
                <div class="text-end">
                    <button id="logoutbtn" type="button" class="btn btn-outline-secondary">Logout</button>
                </div>
            </div>
        </div>
    </header>
    <div class="title_logo">
        <h1>smell</h1>
    </div>
    <div class="title">
    </div>
    <div class="writer">
    </div>
    <div class="date">
    </div>
    <div class="time">
    </div>
    <div class="content">
    </div>
    <div class="card-footer">
        <form id="commentForm">
            <div class="form-group">
                <input id="commentInput" type="text" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="text-end" style="padding-top: 20px;">
                <button id="submitButton" type="submit" class="btn btn-primary">ì‘ì„±</button>
            </div>
        </form>
        <div class="comments mt-3">
        </div>
    </div>
</body>

</html>
